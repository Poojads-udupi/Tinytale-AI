import os
import json
import re
from datetime import datetime
from dotenv import load_dotenv
from fpdf import FPDF
from gtts import gTTS
import gradio as gr

from langchain.prompts import ChatPromptTemplate, SystemMessagePromptTemplate, HumanMessagePromptTemplate
from langchain.memory import ConversationBufferMemory
from llama_index.core import SimpleDirectoryReader, VectorStoreIndex
from langchain_community.chat_models import ChatOpenAI
from llama_index.embeddings.huggingface import HuggingFaceEmbedding

from huggingface_hub import login

# ‚úÖ Load environment variables first
load_dotenv()

# ‚úÖ Login to Hugging Face with token
hf_token = os.getenv("HF_TOKEN")
if not hf_token:
    raise ValueError("‚ùå HF_TOKEN not found in environment")
else:
    login(token=hf_token)

# ‚úÖ Load OpenAI key
openai_key = os.getenv("OPENAI_API_KEY")
if not openai_key:
    raise ValueError("‚ùå OPENAI_API_KEY not found")

# ‚úÖ Initialize LLMs
llm = ChatOpenAI(temperature=0.6, model_name="gpt-3.5-turbo", openai_api_key=openai_key)
teen_memory = ConversationBufferMemory()
embed_model = HuggingFaceEmbedding(model_name="sentence-transformers/all-MiniLM-L6-v2")


# Preload genre-based RAG
file_map = {}
for genre in ["mystery", "comedy", "drama", "romance", "fantasy"]:
    path = os.path.join("story_knowledge/teens", f"{genre}.txt")
    if os.path.exists(path):
        print("üéØ Current Working Directory:", os.getcwd())
        print("üîç Genre Selected:", genre)
        print("üìÑ Looking for file at:", path)
        print("üìÅ File Exists:", os.path.exists(path))

        docs = SimpleDirectoryReader(input_files=[path]).load_data()
        index = VectorStoreIndex.from_documents(docs)
        file_map[genre] = index.as_query_engine()

# TTS fallback
def text_to_speech(text, style="Default"):
    try:
        tts = gTTS(text, lang="en")
        audio_path = "story_audio.mp3"
        tts.save(audio_path)
        return audio_path
    except Exception as e:
        print(f"‚ùå gTTS failed: {e}")
        return None

# Save as PDF
def save_as_pdf(text, name):
    file_name = f"{name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    for line in text.split("\n"):
        pdf.multi_cell(0, 10, line)
    pdf.output(file_name)
    return file_name

# Save story log
def save_story_to_file(character, story_text, age_group="kids", tone="", theme=""):
    story_data = {
        "character": character,
        "story": story_text,
        "age_group": age_group,
        "tone": tone,
        "theme": theme,
        "timestamp": datetime.now().isoformat()
    }
    with open("story_logs.json", "a", encoding="utf-8") as f:
        f.write(json.dumps(story_data) + "\n")

# ---------------- Kids Prompt (ChatPromptTemplate) ----------------
kids_prompt = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(
        "You are a helpful assistant who writes short, fun, age-appropriate stories for kids."
    ),
    HumanMessagePromptTemplate.from_template(
        "Write a {length}-word story for a child aged {age}. "
        "Theme: {theme}. Tone: {tone}. Main character: {name}. "
        "Make it engaging, simple, and creative."
    )
])

def generate_kids(age, theme, tone, name, length):
    messages = kids_prompt.format_messages(age=age, theme=theme, tone=tone, name=name, length=length)
    story = llm(messages).content
    save_story_to_file(name, story, age_group="kids", tone=tone, theme=theme)
    return story
def generate_kids_audio(story):
    return text_to_speech(story)

def generate_kids_pdf(story, name):
    return save_as_pdf(story, name)

# ---------------- Teen Prompt & Sequel (ChatPromptTemplate) ----------------
teen_story_prompt = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(
        "You are a creative writing assistant who helps generate engaging short stories for teens."
    ),
    HumanMessagePromptTemplate.from_template(
        "Write a {length}-word teen story. Tone: {tone}. Character: {name}. Inspiration: {inspiration}"
    )
])

sequel_prompt_template = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(
        "You are a creative assistant generating sequels for teen stories."
    ),
    HumanMessagePromptTemplate.from_template(
        "Write a sequel to the following story:\n\n{last_story}\n\n"
        "Make it {length} words long. Maintain the tone: {tone}. Main character: {name}."
    )
])

def highlight_sections(text):
    for section in ["HOOKS", "CHARACTERS", "SCENES", "TROPES", "SETTINGS"]:
        text = re.sub(fr"\[{section}\]", f"**[{section}]**", text)
    return text

def update_preview(file):
    if file and hasattr(file, "name"):
        try:
            with open(file.name, "r", encoding="utf-8") as f:
                return highlight_sections(f.read())
        except Exception as e:
            return f"‚ùå Error reading file: {e}"
    return ""

def load_default_template():
    try:
        with open("default_template.txt", "r", encoding="utf-8") as f:
            return highlight_sections(f.read())
    except Exception as e:
        return f"‚ùå Failed to load template: {e}"

def toggle_genre_edit(use_edited):
    return gr.update(interactive=not use_edited)

# Track last story for sequel
last_story_text = {"story": ""}
def generate_teen(genre, tone, name, length, uploaded_file=None, edited_text="", use_edited=False, make_sequel=False, voice_style="Default"):
    try:
        uploaded_preview = ""
        retriever = None

        if use_edited and edited_text.strip():
            with open("temp_edited.txt", "w", encoding="utf-8") as f:
                f.write(edited_text)
            docs = SimpleDirectoryReader(input_files=["temp_edited.txt"]).load_data()
            retriever = VectorStoreIndex.from_documents(docs).as_query_engine()
            uploaded_preview = highlight_sections(edited_text)

        elif uploaded_file and hasattr(uploaded_file, "name") and not use_edited:
            docs = SimpleDirectoryReader(input_files=[uploaded_file.name]).load_data()
            retriever = VectorStoreIndex.from_documents(docs).as_query_engine()
            with open(uploaded_file.name, "r", encoding="utf-8") as f:
                uploaded_preview = highlight_sections(f.read())

        elif genre.lower() in file_map:
            retriever = file_map[genre.lower()]
            uploaded_preview = f"**Using preloaded genre template: {genre}**"
        else:
            uploaded_preview = "**Using default inspiration.**"

        # Safely extract inspiration
        if retriever:
            result = retriever.query(f"Inspire a {tone} {genre} story")
            inspiration = result.response if hasattr(result, "response") else str(result)
        else:
            inspiration = "A brave teen facing a challenge."

        prompt_len = length or "150"

        # Check if character name is present
        if not name.strip():
            return "‚ùå Please enter a main character name.", None, None, uploaded_preview

        if make_sequel:
            if not last_story_text["story"]:
                return "‚ùå No previous story found for sequel generation.", None, None, uploaded_preview

            prompt = f"Write a sequel to the following story:\n\n{last_story_text['story']}\n\nContinue the story in around {prompt_len} words. Start the continuation with '--- Continued ---'"
            sequel_story = llm.predict(prompt).strip()
            full_story = f"{last_story_text['story'].strip()}\n\n--- Continued ---\n\n{sequel_story}"
            save_story_to_file(name, full_story, age_group="teen", tone=tone, theme=genre)
            return full_story, uploaded_preview

        messages = teen_story_prompt.format_messages(
            tone=tone,
            name=name.strip(),
            inspiration=inspiration.strip(),
            length=prompt_len
        )
        story = llm(messages).content.strip()
        last_story_text["story"] = story
        save_story_to_file(name, story, age_group="teen", tone=tone, theme=genre)
        return story, uploaded_preview

    except Exception as e:
        return f"‚ùå Error: {e}", ""

def generate_teen_audio(story):
    return text_to_speech(story)

def generate_teen_pdf(story, name):
    return save_as_pdf(story, name)





# ---------------- Gradio UI ----------------
# ---------------- Gradio UI ----------------
with gr.Blocks(title="üìö Children's Story Assistant") as app:

    gr.HTML("""
    <style>
        body {
            background-color: #e8f5e9;
            font-family: 'Segoe UI', sans-serif;
        }
        label.svelte-1ipelgc {
            font-weight: bold;
            font-size: 16px;
            color: #2e7d32;
        }
        select, input[type=radio] {
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 6px;
            font-size: 15px;
            background-color: #ffffff;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.05);
            margin-bottom: 8px;
        }
        textarea, input[type=text] {
            border-radius: 8px;
            border: 1px solid #a5d6a7;
            padding: 8px;
            font-size: 15px;
            background-color: #ffffff;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.05);
        }
        .gr-button.svelte-1ipelgc {
            background-color: #4CAF50 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 8px;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }
        .gr-button.svelte-1ipelgc:hover {
            background-color: #388e3c !important;
        }
        .gr-box {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.05);
        }
        #banner-img img {
            max-width: 60%;
            height: auto;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
        }
    </style>
    """)

    with gr.Column():
        gr.Image(value="banner.jpg", show_label=False, show_download_button=False, container=False, elem_id="banner-img")

    # ‚úÖ Kids UI
    with gr.Tab("Kids"):
        gr.HTML("""
        <div style='background-color: #f8bbd0; color: black; padding: 12px; border-radius: 8px; font-weight: bold;'>
        ‚ú® Welcome to the Kids Story Generator!
        </div>
        """)
        age = gr.Dropdown(["1‚Äì3", "4‚Äì6", "7‚Äì9", "10‚Äì12"], label="Age")
        theme = gr.Dropdown(["Animals", "Adventure", "Magic", "Bedtime"], label="Theme")
        tone = gr.Dropdown(["Happy", "Funny", "Gentle", "Exciting"], label="Tone")
        name = gr.Textbox(label="Character Name")
        length = gr.Radio(["50", "100", "150"], label="Length (words)")
        output = gr.Textbox(label="Story", lines=10)
        story_btn = gr.Button("üìú Generate Story")
        audio = gr.Audio(label="Listen", autoplay=True)
        audio_btn = gr.Button("üîä Generate Voice")
        pdf = gr.File(label="Download PDF")
        pdf_btn = gr.Button("üìÑ Generate PDF")
        clr = gr.Button("Clear")

        story_btn.click(generate_kids, inputs=[age, theme, tone, name, length], outputs=[output])
        audio_btn.click(generate_kids_audio, inputs=[output], outputs=[audio])
        pdf_btn.click(generate_kids_pdf, inputs=[output, name], outputs=[pdf])
        clr.click(lambda: ("", None, None), None, [output, audio, pdf])

    # ‚úÖ Teens UI
    with gr.Tab("Teens"):
        gr.HTML("""
        <div style='background-color: #f8bbd0; color: black; padding: 12px; border-radius: 8px; font-weight: bold;'>
        üéí Welcome to the Teen Story Generator!
        </div>
        """)
        genre2 = gr.Dropdown(["", "Mystery", "Comedy", "Drama", "Romance", "Fantasy"], label="Genre")
        tone2 = gr.Dropdown(["Exciting", "Spooky", "Serious", "Romantic"], label="Tone")
        name2 = gr.Textbox(label="Main Character")
        length2 = gr.Radio(["75", "125", "150"], label="Length (words)")
        uploaded_file = gr.File(label="Upload Template", file_types=[".txt"])
        preview_text = gr.Textbox(label="üìÑ Template Preview", lines=8, interactive=True)
        use_edited = gr.Checkbox(label="‚úçÔ∏è Use Edited Template", value=False)
        sequel_checkbox = gr.Checkbox(label="üîÅ Generate Sequel")
        out2 = gr.Textbox(label="Story", lines=10)
        generate_btn = gr.Button("üìú Generate Story")
        audio2 = gr.Audio(label="Listen", autoplay=True)
        audio2_btn = gr.Button("üîä Generate Voice")
        pdf2 = gr.File(label="Download PDF")
        pdf2_btn = gr.Button("üìÑ Generate PDF")
        clr2 = gr.Button("Clear")

        generate_btn.click(generate_teen, inputs=[genre2, tone2, name2, length2, uploaded_file, preview_text, use_edited, sequel_checkbox], outputs=[out2, preview_text])
        audio2_btn.click(generate_teen_audio, inputs=[out2], outputs=[audio2])
        pdf2_btn.click(generate_teen_pdf, inputs=[out2, name2], outputs=[pdf2])
        clr2.click(lambda: ("", None, None, ""), None, [out2, audio2, pdf2, preview_text])
        uploaded_file.change(fn=update_preview, inputs=uploaded_file, outputs=preview_text)
        use_edited.change(fn=toggle_genre_edit, inputs=use_edited, outputs=genre2)
        gr.Button("üìÑ Load Default Template").click(fn=load_default_template, outputs=preview_text)

app.launch()